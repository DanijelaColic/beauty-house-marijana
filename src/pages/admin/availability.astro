---
import BaseLayout from '@/layouts/BaseLayout.astro';
import AdminLayout from '@/components/admin/AdminLayout';
import StaffAvailabilityView from '@/components/admin/StaffAvailabilityView';
import { createAuthenticatedSupabaseClient } from '@/lib/auth';

// Check if user is authenticated using Supabase client directly
let userRole: 'owner' | 'staff' | null = null;
let currentStaffId: string | undefined = undefined;
let currentStaffName: string | undefined = undefined;

try {
  const supabase = createAuthenticatedSupabaseClient(Astro.cookies);
  
  // Get Supabase user from session
  const { data: { user }, error: userError } = await supabase.auth.getUser();
  
  if (userError || !user) {
    console.error('No Supabase session found:', userError?.message);
    return Astro.redirect('/admin/login');
  }
  
  // Get staff profile
  const { data: profileData, error: profileError } = await supabase
    .from('staff_profiles')
    .select('*')
    .eq('user_id', user.id)
    .single();
  
  if (profileError || !profileData || !profileData.active) {
    console.error('Staff profile error:', profileError?.message);
    return Astro.redirect('/admin/login');
  }
  
  userRole = profileData.role as 'owner' | 'staff';
  currentStaffId = profileData.id;
  currentStaffName = profileData.full_name || profileData.email;
  
  console.log('âœ… Session valid:', { userId: user.id, role: userRole });
} catch (error) {
  console.error('Error checking session:', error);
  return Astro.redirect('/admin/login');
}
---

<BaseLayout
  title="Dostupnost | Beauty House Marijana"
  description="Pregled dostupnih termina za djelatnike"
>
  <AdminLayout client:load>
    <div class="space-y-6">
      <div>
        <h2 class="text-2xl font-bold text-gray-900">Dostupnost termina</h2>
        <p class="text-gray-600 mt-1">
          Pregled slobodnih termina za djelatnike
        </p>
      </div>

      <StaffAvailabilityView 
        client:load
        userRole={userRole}
        currentStaffId={currentStaffId}
        currentStaffName={currentStaffName}
      />
    </div>
  </AdminLayout>
</BaseLayout>

